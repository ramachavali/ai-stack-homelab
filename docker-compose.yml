name: ai-stack

services:
  # Traefik is hosted in coreservices-homelab and reaches routed services via `core-network`.

  # PostgreSQL Database with pgvector
  postgresql:
    image: pgvector/pgvector:pg17
    container_name: postgresql
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./configs/postgres/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - ai-stack
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '${POSTGRES_CPU_LIMIT:-2.0}'
          memory: ${POSTGRES_MEMORY_LIMIT:-2G}
        reservations:
          cpus: '${POSTGRES_CPU_RESERVATION:-0.5}'
          memory: ${POSTGRES_MEMORY_RESERVATION:-512M}

  # Redis Cache
  redis:
    image: redis:latest
    container_name: redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --maxmemory ${REDIS_MAX_MEMORY:-512mb}
      --maxmemory-policy allkeys-lru
    security_opt:
      - no-new-privileges:true
    volumes:
      - redis_data:/data
    networks:
      - ai-stack
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '${REDIS_CPU_LIMIT:-0.5}'
          memory: ${REDIS_MEMORY_LIMIT:-512M}

  # Ollama AI Model Server
  ollama:
    image: ollama/ollama:${OLLAMA_VERSION:-latest}
    container_name: ollama
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
      OLLAMA_HOST: 0.0.0.0
      OLLAMA_KEEP_ALIVE: ${OLLAMA_KEEP_ALIVE:-24h}
      OLLAMA_MAX_LOADED_MODELS: ${OLLAMA_MAX_MODELS:-3}
      OLLAMA_NUM_PARALLEL: ${OLLAMA_PARALLEL:-2}
      OLLAMA_FLASH_ATTENTION: ${OLLAMA_FLASH_ATTENTION:-true}
      OLLAMA_ORIGINS: "*"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - ai-stack
      - core-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ollama.rule=Host(`ollama.local`)"
      - "traefik.http.routers.ollama.entrypoints=websecure"
      - "traefik.http.routers.ollama.tls=true"
      - "traefik.http.services.ollama.loadbalancer.server.port=11434"
    healthcheck:
      test: ["CMD-SHELL", "ollama list > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '${OLLAMA_CPU_LIMIT:-6.0}'
          memory: ${OLLAMA_MEMORY_LIMIT:-12G}
        reservations:
          cpus: '${OLLAMA_CPU_RESERVATION:-1.0}'
          memory: ${OLLAMA_MEMORY_RESERVATION:-2G}

  # n8n Workflow Automation
  n8n:
    image: n8nio/n8n:${N8N_VERSION:-latest}
    container_name: n8n
    restart: unless-stopped
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
    user: node
    security_opt:
      - no-new-privileges:true
    environment:
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgresql
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: n8n_db
      DB_POSTGRESDB_USER: ${POSTGRES_USER}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_POSTGRESDB_SCHEMA: ${N8N_DB_SCHEMA:-public}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      N8N_HOST: ${N8N_HOST:-0.0.0.0}
      N8N_PORT: 5678
      N8N_PROTOCOL: ${N8N_PROTOCOL:-http}
      N8N_LOG_LEVEL: ${N8N_LOG_LEVEL:-info}
      N8N_METRICS: ${N8N_METRICS:-true}
      N8N_API_KEY: ${N8N_API_KEY}
      N8N_AI_ENABLED: ${N8N_AI_ENABLED:-true}
      WEBHOOK_URL: ${N8N_WEBHOOK_URL}
      GENERIC_TIMEZONE: ${TIMEZONE:-UTC}
      TZ: ${TIMEZONE:-UTC}
      NODE_OPTIONS: "--max-old-space-size=${N8N_MAX_MEMORY:-2048}"
    volumes:
      - n8n_data:/home/node/.n8n
      - ${HOST_DROPZONE_PATH}:/home/node/dropzone:rw
      - ${HOST_DOCSTORE_PATH}:/home/node/docstore:rw
    networks:
      - ai-stack
      - core-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.local`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls=true"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    deploy:
      resources:
        limits:
          cpus: '${N8N_CPU_LIMIT:-2.0}'
          memory: ${N8N_MEMORY_LIMIT:-3G}
        reservations:
          cpus: '${N8N_CPU_RESERVATION:-0.5}'
          memory: ${N8N_MEMORY_RESERVATION:-1G}

  # Open WebUI
  open-webui:
    image: ghcr.io/open-webui/open-webui:${OPEN_WEBUI_VERSION:-main}
    container_name: open-webui
    restart: unless-stopped
    depends_on:
      ollama:
        condition: service_healthy
      postgresql:
        condition: service_healthy
      searxng:
        condition: service_healthy
    security_opt:
      - no-new-privileges:true
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgresql:5432/openwebui_db
      OLLAMA_BASE_URL: http://ollama:11434
      LITELLM_BASE_URL: ${LITELLM_BASE_URL:-http://litellm:4000}
      WEBUI_NAME: ${OPEN_WEBUI_NAME:-AI Network}
      OPEN_WEBUI_NAME: ${OPEN_WEBUI_NAME:-AI Network}
      WEBUI_SECRET_KEY: ${OPEN_WEBUI_SECRET_KEY}
      ENABLE_SIGNUP: ${ENABLE_SIGNUP:-true}
      DEFAULT_USER_ROLE: ${DEFAULT_USER_ROLE:-user}
      DEFAULT_LOCALE: ${DEFAULT_LOCALE:-en-US}
      DEFAULT_MODELS: ${DEFAULT_MODELS}
      ENABLE_IMAGE_GENERATION: ${ENABLE_IMAGE_GENERATION:-true}
      ENABLE_RAG_WEB_SEARCH: ${ENABLE_RAG_WEB_SEARCH:-true}
      RAG_WEB_SEARCH_ENGINE: ${RAG_WEB_SEARCH_ENGINE:-searxng}
      RAG_WEB_SEARCH_RESULT_COUNT: ${RAG_WEB_SEARCH_RESULT_COUNT:-5}
      SEARXNG_QUERY_URL: ${SEARXNG_QUERY_URL:-http://searxng:8080/search?q=<query>}
      RAG_EMBEDDING_MODEL: ${RAG_EMBEDDING_MODEL:-nomic-embed-text}
      CHUNK_SIZE: ${CHUNK_SIZE:-1000}
      CHUNK_OVERLAP: ${CHUNK_OVERLAP:-200}
    volumes:
      - open_webui_data:/app/backend/data
      - ${HOST_DOWNLOADS_PATH}:/mnt/host/downloads:rw
      - ${HOST_NETWORK_PATH}:/mnt/host/${USERNAME}-network:rw
      - ${HOST_DROPZONE_PATH}:/mnt/host/dropzone:rw
      - ${HOST_DOCSTORE_PATH}:/mnt/host/docstore:rw
    networks:
      - ai-stack
      - core-network
    ports:
      - "8080:8080"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.open-webui.rule=Host(`open-webui.local`)"
      - "traefik.http.routers.open-webui.entrypoints=websecure"
      - "traefik.http.routers.open-webui.tls=true"
      - "traefik.http.services.open-webui.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '${OPEN_WEBUI_CPU_LIMIT:-1.0}'
          memory: ${OPEN_WEBUI_MEMORY_LIMIT:-1G}
        reservations:
          cpus: '${OPEN_WEBUI_CPU_RESERVATION:-0.25}'
          memory: ${OPEN_WEBUI_MEMORY_RESERVATION:-256M}

  # LiteLLM Proxy
  litellm:
    image: ghcr.io/berriai/litellm:${LITELLM_VERSION:-main-stable}
    container_name: litellm
    restart: unless-stopped
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
    security_opt:
      - no-new-privileges:true
    ports:
      - "4000:4000"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgresql:5432/litellm_db
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY}
      LITELLM_SALT_KEY: ${LITELLM_SALT_KEY}
      UI_USERNAME: ${LITELLM_UI_USERNAME:-admin}
      UI_PASSWORD: ${LITELLM_UI_PASSWORD}
      LITELLM_LOG: ${LITELLM_LOG_LEVEL:-INFO}
      STORE_MODEL_IN_DB: "True"
    volumes:
      - litellm_data:/app/proxy_server_config
      - ./scripts/healthcheck_litellm.py:/opt/healthcheck_litellm.py:ro
    networks:
      - ai-stack
      - core-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.litellm.rule=Host(`litellm.local`)"
      - "traefik.http.routers.litellm.entrypoints=websecure"
      - "traefik.http.routers.litellm.tls=true"
      - "traefik.http.services.litellm.loadbalancer.server.port=4000"
    healthcheck:
      test: ["CMD-SHELL", "python /opt/healthcheck_litellm.py --url http://127.0.0.1:4000/health/liveliness --timeout 5 --ok-range 200:499"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '${LITELLM_CPU_LIMIT:-1.0}'
          memory: ${LITELLM_MEMORY_LIMIT:-1G}

  # n8n MCP Server
  n8n-mcp:
    image: ghcr.io/czlonkowski/n8n-mcp:${N8N_MCP_VERSION:-latest}
    container_name: n8n-mcp
    restart: unless-stopped
    depends_on:
      n8n:
        condition: service_healthy
    init: true
    stdin_open: true
    tty: true
    read_only: true
    security_opt:
      - no-new-privileges:true
    environment:
      N8N_API_URL: http://n8n:5678
      N8N_API_KEY: ${N8N_API_KEY}
      AUTH_TOKEN: ${N8N_MCP_AUTH_TOKEN}
      PORT: 3000
      HOST: 0.0.0.0
      LOG_LEVEL: ${N8N_MCP_LOG_LEVEL:-info}
      MCP_MODE: ${MCP_MODE:-http}
      NODE_ENV: production
      TZ: ${TIMEZONE:-UTC}
    volumes:
      - mcp_data:/app/data
    tmpfs:
      - /tmp
      - /var/log
      - /app/logs
    networks:
      - ai-stack
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'node.*dist/mcp/index.js' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    deploy:
      resources:
        limits:
          cpus: '${N8N_MCP_CPU_LIMIT:-0.5}'
          memory: ${N8N_MCP_MEMORY_LIMIT:-512M}

  # MCPO (MCP Orchestrator)
  mcpo:
    image: ghcr.io/open-webui/mcpo:${MCPO_VERSION:-main}
    container_name: mcpo
    restart: unless-stopped
    depends_on:
      n8n-mcp:
        condition: service_healthy
    entrypoint: ["/app/config/entrypoint.sh"]
    command: ["mcpo", "--host", "0.0.0.0", "--port", "8000", "--config", "/app/config/config.json"]
    security_opt:
      - no-new-privileges:true
    environment:
      MCPO_API_KEY: ${MCPO_API_KEY}
      MCPO_SERVER_TYPE: ${MCPO_SERVER_TYPE:-streamable_http}
      N8N_MCP_AUTH_TOKEN: ${N8N_MCP_AUTH_TOKEN}
      LOG_LEVEL: ${MCPO_LOG_LEVEL:-info}
      TZ: ${TIMEZONE:-UTC}
    volumes:
      - ./configs/mcp/config.template.json:/app/config/config.template.json:ro
      - ./configs/mcp/entrypoint.sh:/app/config/entrypoint.sh:ro
    tmpfs:
      - /tmp
      - /app/config
    networks:
      - ai-stack
      - core-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mcpo.rule=Host(`mcpo.local`)"
      - "traefik.http.routers.mcpo.entrypoints=websecure"
      - "traefik.http.routers.mcpo.tls=true"
      - "traefik.http.services.mcpo.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/docs"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '${MCPO_CPU_LIMIT:-0.25}'
          memory: ${MCPO_MEMORY_LIMIT:-256M}

  # AI + Core Portal Frontend (Flask)
  ai-portal:
    build: ./services
    container_name: ai-portal
    restart: unless-stopped
    depends_on:
      open-webui:
        condition: service_started
      n8n:
        condition: service_started
      litellm:
        condition: service_started
    security_opt:
      - no-new-privileges:true
    environment:
      PORTAL_TITLE: ${PORTAL_TITLE:-AI + Core Services Portal}
      OPEN_WEBUI_URL: ${OPEN_WEBUI_URL:-https://open-webui.local}
      N8N_URL: ${N8N_URL:-https://n8n.local}
      LITELLM_URL: ${LITELLM_URL:-https://litellm.local}
      SEARXNG_URL: ${SEARXNG_URL:-https://searxng.local}
      OLLAMA_URL: ${OLLAMA_URL:-https://ollama.local}
      MCPO_URL: ${MCPO_URL:-https://mcpo.local}
      CORE_FRONTEND_URL: ${CORE_FRONTEND_URL:-https://core.local}
      TRAEFIK_UI_URL: ${TRAEFIK_UI_URL:-https://traefik.local}
      LOGTO_UI_URL: ${LOGTO_UI_URL:-https://auth.local}
      VAULT_UI_URL: ${VAULT_UI_URL:-http://localhost:8200/ui}
    networks:
      - ai-stack
      - core-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ai-portal.rule=Host(`portal.local`)"
      - "traefik.http.routers.ai-portal.entrypoints=websecure"
      - "traefik.http.routers.ai-portal.tls=true"
      - "traefik.http.services.ai-portal.loadbalancer.server.port=5000"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # SearXNG Web Search Engine
  searxng:
    image: searxng/searxng:${SEARXNG_VERSION:-latest}
    container_name: searxng
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
      SEARXNG_BASE_URL: https://searxng.local
      SEARXNG_SECRET: ${SEARXNG_SECRET_KEY}
      SEARXNG_BIND_ADDRESS: 0.0.0.0:8080
    volumes:
      - searxng_data:/etc/searxng
    networks:
      - ai-stack
      - core-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.searxng.rule=Host(`searxng.local`)"
      - "traefik.http.routers.searxng.entrypoints=websecure"
      - "traefik.http.routers.searxng.tls=true"
      - "traefik.http.services.searxng.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '${SEARXNG_CPU_LIMIT:-0.5}'
          memory: ${SEARXNG_MEMORY_LIMIT:-512M}
        reservations:
          cpus: '${SEARXNG_CPU_RESERVATION:-0.1}'
          memory: ${SEARXNG_MEMORY_RESERVATION:-128M}

networks:
  ai-stack:
    driver: bridge
    name: ai-stack

  core-network:
    external: true
    name: core-network

volumes:
  postgres_data:
    name: postgres_data
  redis_data:
    name: redis_data
  ollama_data:
    name: ollama_data
  n8n_data:
    name: n8n_data
  open_webui_data:
    name: open_webui_data
  litellm_data:
    name: litellm_data
  mcp_data:
    name: mcp_data
  searxng_data:
    name: searxng_data
